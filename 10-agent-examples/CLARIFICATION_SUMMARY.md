# åé—®æœºåˆ¶å®ç°æ€»ç»“

## ğŸ“‹ æ¦‚è¿°

åœ¨ `10-agent-examples` ç›®å½•ä¸­æ–°å¢äº†ä¸‰ä¸ªåé—®æœºåˆ¶ï¼ˆClarification Mechanismï¼‰ç¤ºä¾‹ï¼Œå±•ç¤ºäº†ä»åŸºç¡€åˆ°é«˜çº§çš„äººæœºååŒ Agent å®ç°ã€‚

## ğŸ¯ æ–°å¢æ–‡ä»¶

### 1. 11_human_in_the_loop_demo.py
**Human-in-the-Loopï¼ˆåŸºç¡€äººæœºååŒï¼‰**

- **æ ¸å¿ƒæŠ€æœ¯**: LangGraph `interrupt_before` + `MemorySaver`
- **å·¥ä½œæµç¨‹**:
  ```
  åˆ›å»ºè®¡åˆ’ â†’ æ‰§è¡Œæ­¥éª¤ â†’ [ä¸­æ–­] â†’ è¯·æ±‚äººç±»è¾“å…¥ â†’ ç»§ç»­æ‰§è¡Œ â†’ å®Œæˆ
  ```
- **å…³é”®ç‰¹æ€§**:
  - åœ¨é¢„å®šèŠ‚ç‚¹è‡ªåŠ¨æš‚åœ
  - çŠ¶æ€æŒä¹…åŒ–å’Œæ¢å¤
  - æ”¯æŒä¸­æ–­åæ›´æ–°çŠ¶æ€
  - æä¾›äº¤äº’å¼å’Œè‡ªåŠ¨æ¨¡å¼

- **ä½¿ç”¨ç¤ºä¾‹**:
  ```bash
  # äº¤äº’æ¨¡å¼
  python 11_human_in_the_loop_demo.py

  # è‡ªåŠ¨æ¼”ç¤º
  python 11_human_in_the_loop_demo.py --auto
  ```

- **é€‚ç”¨åœºæ™¯**:
  - éœ€è¦äººå·¥å®¡æ ¸çš„å†³ç­–ç‚¹
  - éœ€è¦ç”¨æˆ·æˆæƒçš„æ“ä½œ
  - æ•™å­¦å’Œæ¼”ç¤ºåœºæ™¯

### 2. 12_clarification_agent_demo.py
**Intelligent Clarificationï¼ˆæ™ºèƒ½æ¾„æ¸…ï¼‰**

- **æ ¸å¿ƒæŠ€æœ¯**: LLM è‡ªåŠ¨æ£€æµ‹ + ç»“æ„åŒ–é—®é¢˜ç”Ÿæˆ
- **å·¥ä½œæµç¨‹**:
  ```
  æ£€æµ‹æ¾„æ¸…éœ€æ±‚ â†’ ç”Ÿæˆé—®é¢˜ â†’ å‘ç”¨æˆ·æé—® â†’ ç²¾ç‚¼éœ€æ±‚ â†’ åˆ¶å®šè®¡åˆ’ â†’ æ‰§è¡Œ â†’ å®Œæˆ
  ```
- **æ•°æ®æ¨¡å‹**:
  - `ClarificationQuestion`: ç»“æ„åŒ–é—®é¢˜
  - `ClarificationNeed`: æ¾„æ¸…éœ€æ±‚åˆ¤æ–­
  - `ClarificationResponse`: ç”¨æˆ·å›ç­”

- **é—®é¢˜ç±»å‹**:
  - `scope`: èŒƒå›´ç›¸å…³ï¼ˆè¦†ç›–é¢ã€æ·±åº¦ç­‰ï¼‰
  - `preference`: åå¥½ç›¸å…³ï¼ˆæŠ€æœ¯æ ˆã€é£æ ¼ç­‰ï¼‰
  - `constraint`: çº¦æŸç›¸å…³ï¼ˆæ—¶é—´ã€èµ„æºç­‰ï¼‰
  - `context`: èƒŒæ™¯ç›¸å…³ï¼ˆä½¿ç”¨åœºæ™¯ã€ç›®æ ‡ç­‰ï¼‰

- **ç´§è¿«æ€§çº§åˆ«**:
  - `high`: ä¸æ¾„æ¸…æ— æ³•ç»§ç»­
  - `medium`: æ¾„æ¸…åæ•ˆæœæ›´å¥½
  - `low`: å¯é€‰çš„è¡¥å……ä¿¡æ¯

- **ä½¿ç”¨ç¤ºä¾‹**:
  ```bash
  python 12_clarification_agent_demo.py
  ```

- **é€‚ç”¨åœºæ™¯**:
  - éœ€æ±‚æ¨¡ç³Šçš„ä»»åŠ¡
  - å¤šé¢†åŸŸäº¤å‰ä¸»é¢˜
  - ä¸ªæ€§åŒ–æ¨èç³»ç»Ÿ

### 3. 13_multi_round_clarification_demo.py
**Multi-Round Dialogueï¼ˆå¤šè½®æ¾„æ¸…å¯¹è¯ï¼‰**

- **æ ¸å¿ƒæŠ€æœ¯**: è¿­ä»£å¼æ¾„æ¸… + ä¸Šä¸‹æ–‡æ„ŸçŸ¥ + æ™ºèƒ½åœæ­¢
- **å·¥ä½œæµç¨‹**:
  ```
  ç”Ÿæˆé—®é¢˜ â†’ å‘ç”¨æˆ·æé—® â†’ è¯„ä¼°æ˜¯å¦ç»§ç»­ â†’ [å¾ªç¯] â†’ æ€»ç»“éœ€æ±‚ â†’ æ‰§è¡Œ
  ```
- **å…³é”®ç‰¹æ€§**:
  - åŸºäºå†å²å¯¹è¯ç”Ÿæˆé—®é¢˜ï¼ˆé¿å…é‡å¤ï¼‰
  - è‡ªåŠ¨è¯„ä¼°éœ€æ±‚å®Œæ•´åº¦ï¼ˆ0-1ï¼‰
  - æ™ºèƒ½åœæ­¢æœºåˆ¶ï¼ˆæœ€å¤š 3 è½®ï¼‰
  - éœ€æ±‚æ•´åˆå’Œæ€»ç»“

- **æ•°æ®æ¨¡å‹**:
  - `ClarificationRound`: å•è½®æ¾„æ¸…è®°å½•
  - `ContinueAssessment`: ç»§ç»­åˆ¤æ–­
  - `MultiRoundState`: å¤šè½®çŠ¶æ€ç®¡ç†

- **ä½¿ç”¨ç¤ºä¾‹**:
  ```bash
  python 13_multi_round_clarification_demo.py
  ```

- **é€‚ç”¨åœºæ™¯**:
  - å¤æ‚éœ€æ±‚åˆ†æ
  - æ™ºèƒ½å®¢æœå¯¹è¯
  - åŒ»ç–—è¯Šæ–­åŠ©æ‰‹
  - ä¸ªæ€§åŒ–å’¨è¯¢æœåŠ¡

## ğŸ“Š ä¸‰ç§æ¨¡å¼å¯¹æ¯”

| ç‰¹æ€§ | Human-in-the-Loop | Intelligent Clarification | Multi-Round Dialogue |
|------|-------------------|---------------------------|----------------------|
| **æ–‡ä»¶** | 11_*.py | 12_*.py | 13_*.py |
| **ä»£ç è¡Œæ•°** | ~400 | ~400 | ~450 |
| **è‡ªåŠ¨æ£€æµ‹** | âŒ | âœ… | âœ… |
| **ç»“æ„åŒ–é—®é¢˜** | âŒ | âœ… | âœ… |
| **å¤šè½®è¿­ä»£** | âŒ | âŒ | âœ… |
| **æ™ºèƒ½åœæ­¢** | âŒ | âŒ | âœ… |
| **çŠ¶æ€æŒä¹…åŒ–** | âœ… (MemorySaver) | âŒ | âŒ |
| **ä¸­æ–­æ¢å¤** | âœ… | âŒ | âŒ |
| **å®ç°å¤æ‚åº¦** | ç®€å• | ä¸­ç­‰ | å¤æ‚ |
| **LLM è°ƒç”¨æ¬¡æ•°** | ä¸­ç­‰ | å¤š | æœ€å¤š |

## ğŸ“ å­¦ä¹ è·¯å¾„

### åˆå­¦è€…ï¼ˆç¬¬1å‘¨ï¼‰
1. é˜…è¯» `11_human_in_the_loop_demo.py`
2. ç†è§£ `interrupt_before` æœºåˆ¶
3. è¿è¡Œäº¤äº’å¼å’Œè‡ªåŠ¨æ¨¡å¼
4. ä¿®æ”¹ä¸­æ–­è§¦å‘æ¡ä»¶

### è¿›é˜¶ï¼ˆç¬¬2å‘¨ï¼‰
1. å­¦ä¹  `12_clarification_agent_demo.py`
2. ç†è§£ç»“æ„åŒ–é—®é¢˜ç”Ÿæˆ
3. è‡ªå®šä¹‰é—®é¢˜ç±»å‹å’Œç´§è¿«æ€§
4. é›†æˆåˆ°è‡ªå·±çš„é¡¹ç›®

### é«˜çº§ï¼ˆç¬¬3å‘¨ï¼‰
1. ç ”ç©¶ `13_multi_round_clarification_demo.py`
2. ç†è§£å¤šè½®å¯¹è¯é€»è¾‘
3. ä¼˜åŒ–åœæ­¢æ¡ä»¶ç®—æ³•
4. å®ç°è‡ªå®šä¹‰è¯„ä¼°ç­–ç•¥

## ğŸ›  æŠ€æœ¯å®ç°ç»†èŠ‚

### 1. çŠ¶æ€ç®¡ç†æ¨¡å¼

**Pydantic BaseModel**
```python
class AgentState(BaseModel):
    user_request: str
    clarification_need: Optional[ClarificationNeed] = None
    clarification_responses: List[ClarificationResponse] = Field(default_factory=list)
    # ...
```

ä¼˜ç‚¹ï¼š
- ç±»å‹å®‰å…¨
- è‡ªåŠ¨éªŒè¯
- JSON åºåˆ—åŒ–

### 2. LLM ç»“æ„åŒ–è¾“å‡º

**JSON è§£æç­–ç•¥**
```python
def parse_json_safely(llm, prompt, target_model):
    # 1. æå– JSONï¼ˆæ”¯æŒ markdown ä»£ç å—ï¼‰
    # 2. è§£æå¹¶éªŒè¯ï¼ˆPydanticï¼‰
    # 3. é‡è¯•æœºåˆ¶ï¼ˆæœ€å¤š 2-3 æ¬¡ï¼‰
    # 4. å›é€€æ–¹æ¡ˆ
```

### 3. å·¥ä½œæµè®¾è®¡

**æ¡ä»¶åˆ†æ”¯**
```python
graph.add_conditional_edges(
    "detect",
    lambda s: "ask" if need_clarification(s) else "plan",
    {"ask": "ask", "plan": "plan"}
)
```

**ä¸­æ–­æœºåˆ¶**
```python
workflow = graph.compile(
    checkpointer=MemorySaver(),
    interrupt_before=["request_input"]
)
```

## ğŸ’¡ æœ€ä½³å®è·µ

### 1. é—®é¢˜è®¾è®¡åŸåˆ™
- æ¯è½®æé—® **1-3 ä¸ªé—®é¢˜**ï¼ˆé¿å…ç”¨æˆ·ç–²åŠ³ï¼‰
- é—®é¢˜è¦ **å…·ä½“ã€æ˜ç¡®**
- æä¾› **åˆç†çš„é€‰é¡¹**ï¼ˆä½†å…è®¸è‡ªå®šä¹‰ï¼‰
- è¯´æ˜ **ä¸ºä»€ä¹ˆéœ€è¦è¿™ä¸ªé—®é¢˜**

### 2. ç”¨æˆ·ä½“éªŒä¼˜åŒ–
```
âœ… å¥½çš„æé—®ï¼š
"æ‚¨å¸Œæœ›é‡ç‚¹å…³æ³¨å“ªä¸ªé¢†åŸŸï¼Ÿ
 â†’ åŸå› ï¼šRust åº”ç”¨å¹¿æ³›ï¼Œéœ€è¦æ˜ç¡®æ–¹å‘
 é€‰é¡¹ï¼š1. Web å¼€å‘ 2. ç³»ç»Ÿç¼–ç¨‹ 3. åµŒå…¥å¼"

âŒ ä¸å¥½çš„æé—®ï¼š
"è¯·æè¿°æ‚¨çš„éœ€æ±‚"
ï¼ˆè¿‡äºå¼€æ”¾ï¼Œç”¨æˆ·ä¸çŸ¥é“å¦‚ä½•å›ç­”ï¼‰
```

### 3. åœæ­¢æ¡ä»¶è®¾è®¡
```python
# ç»¼åˆåˆ¤æ–­
should_stop = (
    completeness >= 0.80  # å®Œæ•´åº¦é˜ˆå€¼
    or rounds >= max_rounds  # æœ€å¤§è½®æ•°
    or skip_rate > 0.5  # ç”¨æˆ·è·³è¿‡ç‡
)
```

### 4. é”™è¯¯å¤„ç†
```python
try:
    result = parse_json(llm_output)
except ValidationError:
    # å›é€€æ–¹æ¡ˆ
    result = default_value
```

## ğŸš€ æ‰©å±•æ–¹å‘

### 1. æŒä¹…åŒ–æ¾„æ¸…å†å²
```python
# ä½¿ç”¨ SQLite æˆ– JSON å­˜å‚¨
clarification_db = {
    "user_id": "123",
    "history": [
        {"request": "...", "questions": [...], "answers": [...]}
    ]
}
```

### 2. æ™ºèƒ½é€‰é¡¹æ¨è
```python
def generate_options(question, domain_knowledge):
    # åŸºäºé¢†åŸŸçŸ¥è¯†æ¨èé€‰é¡¹
    # å¯ä»¥ä½¿ç”¨ RAG æˆ–å‘é‡æ•°æ®åº“
    pass
```

### 3. æ¾„æ¸…è´¨é‡è¯„ä¼°
```python
class ClarificationQuality(BaseModel):
    clarity_score: float  # æ¾„æ¸…æ•ˆæœè¯„åˆ†
    user_satisfaction: float  # ç”¨æˆ·æ»¡æ„åº¦
    time_cost: float  # æ—¶é—´æˆæœ¬
```

### 4. Web UI æ”¯æŒ
```python
# ä½¿ç”¨ Streamlit æˆ– Gradio
import streamlit as st

if st.button("æäº¤"):
    clarification = detect_clarification(user_input)
    if clarification.need_clarification:
        for q in clarification.questions:
            st.selectbox(q.question, q.options)
```

## ğŸ“š ç›¸å…³èµ„æº

### LangGraph å®˜æ–¹æ–‡æ¡£
- [Human-in-the-Loop](https://langchain-ai.github.io/langgraph/how-tos/human-in-the-loop/)
- [Checkpointer](https://langchain-ai.github.io/langgraph/reference/checkpoints/)
- [State Management](https://langchain-ai.github.io/langgraph/concepts/low_level/)

### å­¦æœ¯è®ºæ–‡
- **Active Learning**: ä¸»åŠ¨å­¦ä¹ ç†è®º
- **Mixed-Initiative Interaction**: æ··åˆä¸»åŠ¨äº¤äº’
- **Cooperative Dialogue**: åä½œå¯¹è¯ç³»ç»Ÿ

### å®é™…åº”ç”¨æ¡ˆä¾‹
- **GitHub Copilot**: ä»£ç å»ºè®®ä¸­çš„æ¾„æ¸…
- **åŒ»ç–—è¯Šæ–­ç³»ç»Ÿ**: ç—‡çŠ¶æ”¶é›†å¯¹è¯
- **æ™ºèƒ½å®¢æœ**: å¤šè½®é—®é¢˜æ¾„æ¸…
- **ä¸ªæ€§åŒ–æ¨è**: ç”¨æˆ·åå¥½æ”¶é›†

## ğŸ”§ æ•…éšœæ’æŸ¥

### é—®é¢˜ 1: JSON è§£æå¤±è´¥
**åŸå› **: LLM è¾“å‡ºæ ¼å¼ä¸æ­£ç¡®
**è§£å†³**:
- å¢åŠ é‡è¯•æ¬¡æ•°
- ä¼˜åŒ– Promptï¼ˆæ·»åŠ ç¤ºä¾‹ï¼‰
- ä½¿ç”¨æ›´ç¨³å®šçš„æ¨¡å‹

### é—®é¢˜ 2: æ¾„æ¸…åŠŸèƒ½æœªè§¦å‘
**åŸå› **: æ£€æµ‹é€»è¾‘è¿‡äºä¿å®ˆ
**è§£å†³**:
- é™ä½å®Œæ•´åº¦é˜ˆå€¼
- è°ƒæ•´æ£€æµ‹ Prompt
- æ£€æŸ¥ `enable_clarification` æ ‡å¿—

### é—®é¢˜ 3: ç”¨æˆ·ä½“éªŒä¸ä½³
**åŸå› **: é—®é¢˜è¿‡å¤šæˆ–ä¸æ¸…æ™°
**è§£å†³**:
- é™åˆ¶é—®é¢˜æ•°é‡ï¼ˆ1-3 ä¸ªï¼‰
- æä¾›æ¸…æ™°çš„é€‰é¡¹
- è¯´æ˜æé—®åŸå› 

## ğŸ“ˆ æ€§èƒ½è€ƒè™‘

### Token æ¶ˆè€—
- **Human-in-the-Loop**: ~500 tokens/è½®
- **Intelligent Clarification**: ~1000-1500 tokensï¼ˆåŒ…å«æ£€æµ‹ï¼‰
- **Multi-Round**: ~2000-3000 tokensï¼ˆ3 è½®ï¼‰

### å»¶è¿Ÿ
- **ç”¨æˆ·è¾“å…¥æ—¶é—´**: ä¸è®¡å…¥ç³»ç»Ÿå»¶è¿Ÿ
- **LLM è°ƒç”¨**: ä¸»è¦æ—¶é—´æˆæœ¬
- **ä¼˜åŒ–å»ºè®®**: ä½¿ç”¨æ›´å¿«çš„æ¨¡å‹ï¼ˆå¦‚ GPT-4o-miniï¼‰

## âœ… æ€»ç»“

é€šè¿‡è¿™ä¸‰ä¸ªç¤ºä¾‹ï¼Œæ‚¨å·²ç»æŒæ¡äº†ï¼š
1. âœ… åŸºç¡€çš„ Human-in-the-Loop å®ç°
2. âœ… æ™ºèƒ½æ¾„æ¸…é—®é¢˜ç”Ÿæˆ
3. âœ… å¤šè½®å¯¹è¯ç®¡ç†
4. âœ… çŠ¶æ€æŒä¹…åŒ–å’Œæ¢å¤
5. âœ… ç»“æ„åŒ–æ•°æ®å»ºæ¨¡
6. âœ… å·¥ä½œæµæ¡ä»¶åˆ†æ”¯

ä¸‹ä¸€æ­¥å¯ä»¥ï¼š
- å°†è¿™äº›æŠ€æœ¯é›†æˆåˆ°æ‚¨çš„é¡¹ç›®ä¸­
- æ‰©å±•ä¸º Web åº”ç”¨
- ä¼˜åŒ–æ¾„æ¸…ç­–ç•¥
- æ·»åŠ æŒä¹…åŒ–å­˜å‚¨

## ğŸ™ åé¦ˆ

å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œæ¬¢è¿æäº¤ Issue æˆ– Pull Requestï¼
