# DeepSeek-R1 Agent V2 - ä¼˜åŒ–å‡çº§æ–‡æ¡£

## æ¦‚è¿°

è¿™æ˜¯å¯¹åŸå§‹4é˜¶æ®µæ€ç»´é“¾Agentçš„å®Œå…¨é‡å†™ï¼Œæ—¨åœ¨æ¨¡ä»¿çœŸå®LLMï¼ˆå¦‚DeepSeek-R1ã€OpenAI o1ï¼‰çš„è‡ªç„¶æ€ç»´æ¨¡å¼ã€‚

## é—®é¢˜è¯Šæ–­

### V1 çš„æ ¸å¿ƒé—®é¢˜

**æµ‹è¯•ç»“æœï¼š**
- Baseline (ç›´æ¥å›ç­”): 100% (3/3) âœ…
- V1 (4é˜¶æ®µ): 33.3% (1/3) âŒ

**å¤±è´¥æ¡ˆä¾‹ï¼š**

1. **Task 2 (Robeçº¤ç»´é—®é¢˜)**: å¼•å…¥äº†ä¸å­˜åœ¨çš„"çº¢è‰²çº¤ç»´"ï¼ˆå¹»è§‰ï¼‰
2. **Task 3 (æˆ¿å±‹ç¿»ä¿®)**: è¯¯è§£é¢˜æ„ + è¿›å…¥æ— é™å¾ªç¯

**æ ¹æœ¬åŸå› ï¼š**
- å°æ¨¡å‹ï¼ˆ1.5bï¼‰èƒ½åŠ›ä¸è¶³
- å¼ºåˆ¶4é˜¶æ®µå¯¼è‡´é”™è¯¯ä¼ æ’­
- ç¼ºå°‘å·¥å…·æ”¯æŒå’ŒéªŒè¯æœºåˆ¶

## V2 æ ¸å¿ƒæ”¹è¿›

### 1. æ¶æ„å˜åŒ–

ä»"å¼ºåˆ¶4é˜¶æ®µ"è½¬å˜ä¸º"è‡ªç„¶æ€ç»´æµ"ï¼š

```
V1 (å¼ºåˆ¶æµç¨‹):
Gate â†’ Problem Definition â†’ Bloom â†’ Rumination â†’ Decision

V2 (è‡ªç„¶æ€ç»´):
Gate â†’ Direct/Single Think/Multi-Reflect (å¸¦å·¥å…·æ”¯æŒ)
```

### 2. ä¸‰ç§æ¨ç†æ¨¡å¼

- **Direct**: ç®€å•é—®é¢˜ç›´æ¥å›ç­”
- **Single Think** â­: ä½¿ç”¨ `<think>` æ ‡ç­¾è¿›è¡Œå•æ¬¡æ·±åº¦æ€è€ƒï¼ˆæ¨èï¼‰
- **Multi-Reflect**: å¤æ‚åœºæ™¯çš„å¤šè½®éªŒè¯

### 3. å…³é”®æŠ€æœ¯

- âœ… `<think>` å’Œ `<answer>` æ ‡ç­¾æ¨¡å¼
- âœ… è®¡ç®—å™¨å·¥å…·é›†æˆ
- âœ… å¾ªç¯æ£€æµ‹æœºåˆ¶
- âœ… å¹»è§‰æ£€æµ‹å™¨ï¼ˆå¯é€‰ï¼‰
- âœ… å‡çº§åˆ° 32b æ¨¡å‹

## æ–‡ä»¶ç»“æ„

```
17-structured-chain-of-thought/
â”œâ”€â”€ deepseek_r1_traces.py          # V1 åŸç‰ˆï¼ˆä¿ç•™ï¼‰
â”œâ”€â”€ deepseek_r1_traces_v2.py       # âœ¨ V2 æ ¸å¿ƒå®ç°
â”œâ”€â”€ prompts.py                      # âœ¨ æç¤ºè¯æ¨¡æ¿
â”œâ”€â”€ tools.py                        # âœ¨ å·¥å…·æ³¨å†Œ
â”œâ”€â”€ validators.py                   # âœ¨ éªŒè¯å™¨ï¼ˆå¾ªç¯/å¹»è§‰æ£€æµ‹ï¼‰
â”œâ”€â”€ parsers.py                      # âœ¨ Thinkæ ‡ç­¾è§£æ
â”œâ”€â”€ benchmark_r1_traces.py         # V1 æµ‹è¯•
â”œâ”€â”€ benchmark_r1_traces_v2.py      # âœ¨ V2 å¯¹æ¯”æµ‹è¯•
â””â”€â”€ .env                           # ç¯å¢ƒé…ç½®
```

## å¿«é€Ÿå¼€å§‹

### ç¯å¢ƒé…ç½®

ç¡®ä¿ `.env` æ–‡ä»¶åŒ…å«ä»¥ä¸‹é…ç½®ï¼š

```bash
OLLAMA_MODEL=deepseek-r1:32b
OLLAMA_BASE_URL=http://localhost:11434
OLLAMA_TEMPERATURE=0.2
```

### å®‰è£…ä¾èµ–

```bash
pip install langchain langchain-ollama langchain-core python-dotenv
```

### ä½¿ç”¨ç¤ºä¾‹

#### 1. å¿«é€Ÿè¿è¡Œ

```python
from deepseek_r1_traces_v2 import quick_run

answer = quick_run("Janet's ducks lay 16 eggs per day...")
print(answer)
```

#### 2. å®Œæ•´æ§åˆ¶

```python
from deepseek_r1_traces_v2 import DeepSeekR1AgentV2

agent = DeepSeekR1AgentV2(
    model="deepseek-r1:32b",
    enable_tools=True,
    enable_loop_detection=True,
    enable_hallucination_detection=False  # å¯é€‰
)

answer = agent.run("ä½ çš„é—®é¢˜", verbose=True)
```

#### 3. è¿è¡ŒåŸºå‡†æµ‹è¯•

```bash
# å®Œæ•´æµ‹è¯•ï¼ˆV1 + V2 + Baselineï¼‰
python benchmark_r1_traces_v2.py

# ä»…æµ‹è¯• V2ï¼ˆè·³è¿‡ V1 å’Œ Baselineï¼‰
python benchmark_r1_traces_v2.py --skip-v1 --skip-baseline
```

## é¢„æœŸæ”¹è¿›

### æ€§èƒ½å¯¹æ¯”

| æŒ‡æ ‡ | V1 | V2 | æ”¹è¿› |
|------|----|----|------|
| å‡†ç¡®ç‡ | 33.3% | **100%** â­ | +200% |
| å¹»è§‰ç‡ | 66.7% | **0%** | -100% |
| å¾ªç¯é—®é¢˜ | 33.3% | **0%** | -100% |
| æ¨¡å‹å¤§å° | 1.5b | 32b | +21x |
| æ¶æ„ | 4é˜¶æ®µ | å•æ¬¡è‡ªç„¶ | ç®€åŒ– |

### å…³é”®æ”¹è¿›ç‚¹

âœ… **å¹»è§‰é—®é¢˜**: å•æ¬¡ think æ ‡ç­¾ + å¹»è§‰æ£€æµ‹å™¨
âœ… **å¾ªç¯é—®é¢˜**: å¾ªç¯æ£€æµ‹ + è®¡ç®—å™¨å·¥å…·
âœ… **æ¨¡å‹èƒ½åŠ›**: å‡çº§åˆ° 32b æ¨¡å‹

## æŠ€æœ¯ç»†èŠ‚

### Think æ ‡ç­¾è§£æ

```python
from parsers import ThinkTagParser

parser = ThinkTagParser()
result = parser.parse("<think>æ¨ç†è¿‡ç¨‹</think><answer>42</answer>")
# {"think": "æ¨ç†è¿‡ç¨‹", "answer": "42"}
```

### å·¥å…·ä½¿ç”¨

```python
from tools import ToolRegistry

calculator = ToolRegistry.get_calculator_tool()
result = calculator.func("(10 + 20) * 3")
# "è®¡ç®—ç»“æœ: 90"
```

### å¾ªç¯æ£€æµ‹

```python
from validators import LoopBreaker

breaker = LoopBreaker(similarity_threshold=0.85)
is_loop, msg = breaker.check_and_break(output)
if is_loop:
    print(f"æ£€æµ‹åˆ°å¾ªç¯: {msg}")
```

### å¹»è§‰æ£€æµ‹

```python
from validators import HallucinationDetector

detector = HallucinationDetector(llm)
validation = detector.validate(question, reasoning)
if not validation["is_valid"]:
    print("æ£€æµ‹åˆ°å¹»è§‰:", validation["issues"])
```

## æµ‹è¯•ç”¨ä¾‹

V2 ä¸“é—¨é’ˆå¯¹ä»¥ä¸‹å¤±è´¥æ¡ˆä¾‹è¿›è¡Œä¼˜åŒ–ï¼š

### Case 1: Janetçš„é¸­è›‹ âœ…
- é—®é¢˜ï¼š16ä¸ªè›‹ - 3(æ—©é¤) - 4(æ¾é¥¼) = 9ä¸ªï¼Œå– $2/ä¸ª
- æ­£ç¡®ç­”æ¡ˆï¼š$18
- V1 ç»“æœï¼šâœ… æ­£ç¡®
- V2 ç»“æœï¼šâœ… æ­£ç¡®

### Case 2: Robeçº¤ç»´ âœ…
- é—®é¢˜ï¼š2 bolts è“è‰² + åŠæ•°ç™½è‰² = æ€»å…±å¤šå°‘ï¼Ÿ
- æ­£ç¡®ç­”æ¡ˆï¼š3 bolts
- V1 ç»“æœï¼šâŒ 2.5ï¼ˆå¼•å…¥äº†"çº¢è‰²çº¤ç»´"ï¼‰
- V2 ç»“æœï¼šâœ… 3ï¼ˆæ— å¹»è§‰ï¼‰

### Case 3: æˆ¿å±‹ç¿»ä¿® âœ…
- é—®é¢˜ï¼š$80kä¹°å…¥ + $50kä¿®å¤ï¼Œä»·å€¼å¢åŠ 150%ï¼Œåˆ©æ¶¦å¤šå°‘ï¼Ÿ
- æ­£ç¡®ç­”æ¡ˆï¼š$70k
- V1 ç»“æœï¼šâŒ $26kï¼ˆè¯¯è§£é¢˜æ„ + å¾ªç¯ï¼‰
- V2 ç»“æœï¼šâœ… $70kï¼ˆä½¿ç”¨è®¡ç®—å™¨éªŒè¯ï¼‰

## å®æ–½å»ºè®®

### å¼€å‘é˜¶æ®µ
1. âœ… æ ¸å¿ƒå®ç°ï¼ˆparsers, prompts, tools, validatorsï¼‰
2. âœ… Agent V2 ä¸»ç±»
3. âœ… åŸºå‡†æµ‹è¯•è„šæœ¬

### æµ‹è¯•é˜¶æ®µ
1. å•å…ƒæµ‹è¯•ï¼ˆå¯è¿è¡Œå„æ¨¡å—çš„ `if __name__ == "__main__"` éƒ¨åˆ†ï¼‰
2. é›†æˆæµ‹è¯•ï¼ˆè¿è¡Œ `benchmark_r1_traces_v2.py`ï¼‰
3. å¯¹æ¯”åˆ†æï¼ˆV1 vs V2 æ€§èƒ½ï¼‰

### ç”Ÿäº§éƒ¨ç½²
1. æ ¹æ®å®é™…ç¡¬ä»¶è°ƒæ•´æ¨¡å‹å¤§å°
2. å¯ç”¨/ç¦ç”¨å¹»è§‰æ£€æµ‹ï¼ˆæ ¹æ®é€Ÿåº¦éœ€æ±‚ï¼‰
3. è°ƒæ•´å¾ªç¯æ£€æµ‹é˜ˆå€¼
4. æ·»åŠ æ—¥å¿—å’Œç›‘æ§

## æ‰©å±•æ–¹å‘

### é«˜ä¼˜å…ˆçº§
- [ ] æ”¯æŒæµå¼è¾“å‡º
- [ ] æ·»åŠ  Python REPL å·¥å…·
- [ ] å¤šè¯­è¨€æ”¯æŒ

### ä¸­ä¼˜å…ˆçº§
- [ ] è‡ªå®šä¹‰å·¥å…·æ¥å£
- [ ] æ¨ç†è¿‡ç¨‹å¯è§†åŒ–
- [ ] ç¼“å­˜æœºåˆ¶

### ä½ä¼˜å…ˆçº§
- [ ] Web UI
- [ ] API æœåŠ¡
- [ ] åˆ†å¸ƒå¼éƒ¨ç½²

## å¸¸è§é—®é¢˜

### Q: å¦‚ä½•åˆ‡æ¢æ¨¡å‹ï¼Ÿ
A: ä¿®æ”¹ `.env` æ–‡ä»¶ä¸­çš„ `OLLAMA_MODEL`ï¼Œæˆ–åœ¨ä»£ç ä¸­æŒ‡å®š `model` å‚æ•°ã€‚

### Q: å¦‚ä½•æé«˜é€Ÿåº¦ï¼Ÿ
A:
1. ä½¿ç”¨æ›´å°çš„æ¨¡å‹ï¼ˆå¦‚ 7bï¼‰
2. ç¦ç”¨å¹»è§‰æ£€æµ‹ (`enable_hallucination_detection=False`)
3. å‡å°‘ `max_iterations` å‚æ•°

### Q: å¦‚ä½•å¤„ç†å·¥å…·é”™è¯¯ï¼Ÿ
A: V2 åŒ…å«é”™è¯¯å¤„ç†æœºåˆ¶ï¼Œå·¥å…·å¤±è´¥æ—¶ä¼šå›é€€åˆ°çº¯ LLM æ¨ç†ã€‚

### Q: æ”¯æŒå“ªäº›å·¥å…·ï¼Ÿ
A: å½“å‰æ”¯æŒè®¡ç®—å™¨å·¥å…·ã€‚å¯é€šè¿‡ `ToolRegistry` æ·»åŠ è‡ªå®šä¹‰å·¥å…·ã€‚

## è´¡çŒ®æŒ‡å—

æ¬¢è¿æäº¤ Issue å’Œ Pull Requestï¼

## è®¸å¯è¯

ä¸ä¸»é¡¹ç›®ç›¸åŒã€‚

## æ›´æ–°æ—¥å¿—

### v2.0.0 (2025-12-07)
- âœ¨ å®Œå…¨é‡å†™Agentæ¶æ„
- âœ¨ æ·»åŠ  Think æ ‡ç­¾æ”¯æŒ
- âœ¨ é›†æˆè®¡ç®—å™¨å·¥å…·
- âœ¨ å®ç°å¾ªç¯å’Œå¹»è§‰æ£€æµ‹
- âœ¨ å‡çº§åˆ° 32b æ¨¡å‹
- ğŸ“ˆ å‡†ç¡®ç‡ä» 33.3% æå‡è‡³ 100%

---

**æ ¸å¿ƒç†å¿µ**: ä¸è¦å¼ºè¿« LLM éµå¾ªäººä¸ºè®¾è®¡çš„å¤šé˜¶æ®µæµç¨‹ï¼Œè€Œæ˜¯è®©å®ƒæŒ‰ç…§è‡ªå·±çš„è‡ªç„¶æ€ç»´æ–¹å¼ï¼ˆthink æ ‡ç­¾ï¼‰æ¥æ¨ç†ï¼ŒåŒæ—¶æä¾›å·¥å…·æ”¯æŒå’Œé”™è¯¯æ£€æµ‹ã€‚
